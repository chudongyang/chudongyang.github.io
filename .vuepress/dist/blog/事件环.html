<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器和Node事件环 | Promise-学习笔记</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="从头开始总结学习笔记，包括但不限于javaScript基础、vue和react相关、node相关等，每天总结一点点，积少成多...">
    <link rel="preload" href="/assets/css/0.styles.70ebe3f1.css" as="style"><link rel="preload" href="/assets/js/app.32ac00d1.js" as="script"><link rel="preload" href="/assets/js/2.d723362d.js" as="script"><link rel="preload" href="/assets/js/20.b933b658.js" as="script"><link rel="prefetch" href="/assets/js/10.7978180b.js"><link rel="prefetch" href="/assets/js/11.0cf5285c.js"><link rel="prefetch" href="/assets/js/12.12de4974.js"><link rel="prefetch" href="/assets/js/13.eb0d93c5.js"><link rel="prefetch" href="/assets/js/14.86e0feeb.js"><link rel="prefetch" href="/assets/js/15.ab02c48c.js"><link rel="prefetch" href="/assets/js/16.741aa76d.js"><link rel="prefetch" href="/assets/js/17.a1f81df8.js"><link rel="prefetch" href="/assets/js/18.56d29a4c.js"><link rel="prefetch" href="/assets/js/19.7cecbc4f.js"><link rel="prefetch" href="/assets/js/21.27839f5a.js"><link rel="prefetch" href="/assets/js/22.751ee638.js"><link rel="prefetch" href="/assets/js/23.22f249c4.js"><link rel="prefetch" href="/assets/js/24.95757766.js"><link rel="prefetch" href="/assets/js/25.178a9429.js"><link rel="prefetch" href="/assets/js/26.28890703.js"><link rel="prefetch" href="/assets/js/27.ada3a9ea.js"><link rel="prefetch" href="/assets/js/28.f177f173.js"><link rel="prefetch" href="/assets/js/29.af0729a9.js"><link rel="prefetch" href="/assets/js/3.f28d3c28.js"><link rel="prefetch" href="/assets/js/30.ce0af935.js"><link rel="prefetch" href="/assets/js/31.af532938.js"><link rel="prefetch" href="/assets/js/32.d362b63b.js"><link rel="prefetch" href="/assets/js/33.4f4099d1.js"><link rel="prefetch" href="/assets/js/34.9d0eb9b8.js"><link rel="prefetch" href="/assets/js/35.e026493d.js"><link rel="prefetch" href="/assets/js/4.0e3a0dc2.js"><link rel="prefetch" href="/assets/js/5.46878165.js"><link rel="prefetch" href="/assets/js/6.b0d74926.js"><link rel="prefetch" href="/assets/js/7.4abc5b00.js"><link rel="prefetch" href="/assets/js/8.e3eb507a.js"><link rel="prefetch" href="/assets/js/9.52ee74cf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.70ebe3f1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Promise-学习笔记</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://juejin.im/user/586687fe61ff4b006db52c79/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金专栏
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chudongyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/chudongyang/chudongyang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客仓库
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chudongyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://juejin.im/user/586687fe61ff4b006db52c79/posts" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金专栏
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chudongyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/chudongyang/chudongyang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客仓库
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/chudongyang" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>square-ui 组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/components/button.html" class="sidebar-link">按钮组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>javaScript相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/javaScript/basic.html" class="sidebar-link">js基础</a></li><li><a href="/javaScript/mackdown基础语法.html" class="sidebar-link">mackdown基础语法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>vue相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue/basic.html" class="sidebar-link">什么是库？什么是框架</a></li><li><a href="/vue/comLibrary.html" class="sidebar-link">从零搭建 vue 组件库</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>react相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/basic.html" class="sidebar-link">react基础</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>小程序</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/wechat/error.html" class="sidebar-link">常见小程序错误的处理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>TypeScript相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TypeScript/basic.html" class="sidebar-link">ts-简介</a></li><li><a href="/TypeScript/数据类型.html" class="sidebar-link">ts-数据类型</a></li><li><a href="/TypeScript/函数.html" class="sidebar-link">ts-函数</a></li><li><a href="/TypeScript/类.html" class="sidebar-link">ts-类</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>flutter相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/flutter/install.html" class="sidebar-link">mac 下 fluter 的环境配置</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指令相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/command/git.html" class="sidebar-link">git相关</a></li><li><a href="/command/npm.html" class="sidebar-link">npm相关</a></li><li><a href="/command/brew.html" class="sidebar-link">brew相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据库相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/db/MySQL.html" class="sidebar-link">mac下MySQL的安装</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>book相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/HTTP.html" class="sidebar-link">图解HTTP</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>博客文章</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/travis和vuepress搭建github仓库.html" class="sidebar-link">VuePress+Travis+Github搭建文档</a></li><li><a href="/blog/promise实现.html" class="sidebar-link">Promise实现</a></li><li><a href="/blog/事件环.html" class="active sidebar-link">浏览器和Node事件环</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/nodeJs流.html" class="sidebar-link">Node.js流</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="浏览器和node事件环"><a href="#浏览器和node事件环" class="header-anchor">#</a> 浏览器和Node事件环</h3> <img src="/eventloop.jpg" height="410" width="auto"> <p>进入正文之前，首先要感谢各位大佬对本人第一篇掘金文章《<a href="https://juejin.im/post/5b5b52dbe51d4534c34a4a6e" target="_blank" rel="noopener noreferrer">ES6版Promise实现，给你不一样的体验<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>》的肯定及指正，可能写的不尽人意，但是你们的点赞会是我继续分享的动力之一，只要努力过，结果就不要太在意，因为努力之后的结果会让你满意！与诸位共勉！</p> <p>好了，话不多说，接下来让我们进入今天的话题。今天我们来谈一谈事件环到底是什么？<code>javaScript</code>的事件环和<code>Node</code>的事件环有什么区别？有没有一种无从下手的感觉，别捉急，只要你仔细阅读本篇文章，相信能够解开心中的疑惑。
<img src="https://user-gold-cdn.xitu.io/2018/7/31/164f0edfde32d253?w=100&amp;h=80&amp;f=gif&amp;s=35590" alt=""></p> <h3 id="先了解几组常见概念"><a href="#先了解几组常见概念" class="header-anchor">#</a> 先了解几组常见概念</h3> <p>俗话说，工欲善其事必先利其器。在进入浏览器事件环和Node事件环情节之前呢，我们有必要了解以下几组常见的概念。</p> <ol><li>heap（堆）和 stack（栈）
堆栈是在计算机领域不可忽视的概念，如果想要详细了解，请移步《<a href="https://baike.baidu.com/item/%E5%A0%86%E6%A0%88/1682032" target="_blank" rel="noopener noreferrer">堆栈_百度百科<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>》。在javaScript中，栈中存的是基本数据类型，会自动分配内存空间，自动释放；堆中存的是引用数据类型，是动态分配的内存，大小不定也不会自动释放。</li></ol> <ul><li><code>heap</code>堆：也可以叫堆内存；是一种队列优先，先进先出的数据结构；</li> <li><code>stack</code>栈：又名'堆栈',也是一种数据结构，不过它是按照先进后出原则存储数据的。
<img src="https://user-gold-cdn.xitu.io/2018/7/31/164f0a4b342417fa?w=1049&amp;h=443&amp;f=png&amp;s=29234" alt=""></li></ul> <blockquote><p>嘻嘻😝，自己花了半天时间（夸张）画得，自我感觉良好。</p></blockquote> <p>既然我们大致理解了堆和栈的含义，我们来看一道面试题，如何用js代码实现队列和栈的功能呢？其实很简单啦，就是数组最基本常用的增删方法。</p> <ul><li>实现队列的方法（先进先出）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>实现栈的方法（先进后出）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>线程和进程
首先，我们应该知道进程比线程要大。一个程序至少要有一个进程，一个进程至少要有一个线程。就拿我们经常用的浏览器为例吧，为了更直观一些，先看下这张图片：</li></ol> <p><img src="https://user-gold-cdn.xitu.io/2018/8/2/164f6492a3e468b6?w=532&amp;h=408&amp;f=png&amp;s=23809" alt="">
由此可见，浏览器就是多进程的，当一个网页崩溃时不会影响其他网页的正常运行。我们主要了解下一下几个方面：</p> <ul><li>渲染引擎：渲染引擎内部是多线程的,内部包含了两个最重要的线程ui线程和js线程。这里要特别注意ui线程和js线程是互斥的,因为JS运行结果会影响到ui线程的结果。ui更新会被保存在队列中等到js线程空闲时立即被执行。</li> <li>js单线程：<code>JavaScript</code>最大的特点就是单线程的，其实应该说其主线程是单线程的。为什么这么说呢？你想一下，如果js是多线程的，我们在页面中这个线程要删了那个元素（不顺眼），另一个线程呢我要保留那个元素（我罩着的），这样岂不是就乱套了。这也是为什么<code>JavaScript</code>执行同步代码，异步代码并不会阻塞代码的运行。</li> <li>其他线程：
<ul><li>浏览器事件触发线程(用来控制事件循环,存放<code>setTimeout</code>、浏览器事件、<code>ajax</code>的回调函数)</li> <li>定时触发器线程(<code>setTimeout</code>定时器所在线程)</li> <li>异步HTTP请求线程(<code>ajax</code>请求线程)</li></ul></li></ul> <ol start="3"><li>宏任务和微任务
宏任务和微任务可以说都是异步任务。如果了解<code>vue</code>源码的同学，应该知道宏任务<code>macrotask</code>和微任务<code>microtask</code>这两个概念，他们的执行时机是不一样的。<code>vue</code>的<code>$nextTick</code>的源码就是通过宏任务和微任务实现的。(可以去<a href="https://github.com/vuejs/vue/tree/dev/src/core/util" target="_blank" rel="noopener noreferrer">vue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的github了解一下其实现原理)。</li></ol> <ul><li>常见的宏任务<code>macrotask</code>有：<code>setTimeout</code>、<code>setInterval</code>、 <code>setImmediate</code>(ie浏览器才支持,node中自己也实现了)、<code>MessageChannel</code></li> <li>常见的微任务<code>microtask</code>有：<code>promise.then()</code>、<code>process.nextTick</code>(node的)</li></ul> <h3 id="javascript的事件环"><a href="#javascript的事件环" class="header-anchor">#</a> javaScript的事件环</h3> <p>浏览器中，事件环的运行机制是，先会执行栈中的内容，栈中的内容执行后执行微任务，微任务清空后再执行宏任务，先取出一个宏任务，再去执行微任务，然后在取宏任务清微任务这样不停的循环，我们可以看下面这张图理解一下：</p> <p><img src="https://user-gold-cdn.xitu.io/2018/8/2/164f63da02998416?w=638&amp;h=359&amp;f=jpeg&amp;s=49329" alt=""></p> <blockquote><p>从图中可以看出，同步任务会进入执行栈，而异步任务会进入任务队列（callback queue）等待执行。一旦执行栈中的内容执行完毕，就会读取任务队列中等待的任务放入执行栈开始执行。（图中缺少微任务）</p></blockquote> <p>那么，我们来道面试题检验一下，当我们在浏览器中运行下面的代码，输出的结果是什么呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出结果：2 then1 then2 setTimeout1  then3  setTimeout2</span>
</code></pre></div><blockquote><ol><li>先执行栈中的内容，也就是同步代码，所以2被输出出来；</li> <li>然后清空微任务，所以依次输出的是 <code>then1</code> <code>then2</code>；</li> <li>因代码是从上到下执行的，所以1s后 <code>setTimeout1</code> 被执行输出；</li> <li>接着再次清空微任务，<code>then3</code>被输出；</li> <li>最后执行输出<code>setTimeout2</code></li></ol></blockquote> <h3 id="node的事件环"><a href="#node的事件环" class="header-anchor">#</a> Node的事件环</h3> <p><code>Node</code>是基于V8引擎的<code>JavaScript</code>运行环境，在处理高并发、I/O密集(文件操作、网络操作、数据库操作等)场景有明显的优势。Node的事件环机制与浏览器的是不太一样。
在Node运行环境中：</p> <ol><li>我们写的js代码会交由V8引擎进行处理</li> <li>代码中可能会调用NodeApi，node会交由<code>libuv</code>处理</li> <li><code>libuv</code>通过阻塞I/O和多线程实现异步I/O</li> <li>然后通过事件驱动的方式，将结果放到事件队列中，最终交给我们的应用。</li></ol> <p>其实本质是在<code>libuv</code>(一个高性能的，事件驱动的I/O库)内部有这样一个事件环机制。在Node启动时会初始化事件环，话不多说，先上图：</p> <p><img src="https://user-gold-cdn.xitu.io/2018/8/4/165058b12d81586b?w=614&amp;h=673&amp;f=png&amp;s=55350" alt="">
图中显示的每个阶段都对应一个事件队列，当<code>event loop</code>执行到某个阶段时会将当前阶段对应的队列依次执行。当队列执行完毕或者执行数量超过上限时，才会转入下一个阶段。node中的微任务在切换队列时执行。</p> <ul><li><code>timers</code>计时器：执行<code>setTimeout</code>、<code>setInterval</code>的回调函数；</li> <li><code>I/O callbacks</code>：执行<code>I/O callback</code>被延迟到下一阶段执行；</li> <li><code>idle, prepare</code>：队列的移动，仅内部使用</li> <li><code>poll</code>轮询：检索新的I/O事件;执行I/O相关的回调</li> <li><code>check</code>：执行<code>setImmediate</code>回调</li> <li><code>close callbacks</code>：执行<code>close</code>事件的<code>callback</code>，例如<code>socket.on(&quot;close&quot;,func)</code></li></ul> <p>好了，接下来我们先来看一道简单的测试题：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>这道题中如果你在<code>node</code>环境中多运行几次，就会发现输出顺序是不固定的。也就是说虽然上图中<code>timers</code>队列在<code>check</code>队列前面，但是<code>setTimeout</code>和<code>setImmediate</code>没有明确的先后顺序的，这是由<code>node</code>的准备时间（准备工作会浪费一定的时间）导致的。</p></blockquote> <p>对应上面这道练习题，我们再来看下面这道题：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./1.txt'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>这道题的输出顺序是<code>setImmediate</code>然后<code>setTimeout</code>，无论你运行多少次，结果顺序不会发生改变。这是因为<code>fs</code>文件操作（I/O操作）属于属于<code>poll</code>阶段，<code>poll</code>阶段的下一阶段就是<code>check</code>阶段，所以输出顺序是毋庸置疑的。</p></blockquote> <p>最后，让我们来再看一道面试题加深对Node事件环的理解：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'nextTick'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>这道题的输出顺序是：<code>then、setTimeout2、nextTick、setImmediate1、setImmediate2、setTimeout1</code>，为什么是这样的顺序呢？微任务<code>nextTick</code>的输出是因为<code>timers</code>队列切换到<code>check</code>队列，<code>setImmediate1</code>和<code>setImmediate2</code>连续输出是因只有当前队列执行完毕后才能进去下一对列。</p></blockquote> <p>总结：今天的话题就先到这里了。可能本文有表述不清楚或者理解不对的地方，还请各位大佬给予指正，我会继续努力每周分享，万分感谢！如果您觉得看了这篇文章有所收获，请不要忘了动动手指点个小❤️哦！让我们一起荡起双桨，每天进步一点点，在技术的道路上越走越远！
<img src="https://user-gold-cdn.xitu.io/2018/8/5/16505b27e9e0d02b?w=240&amp;h=240&amp;f=jpeg&amp;s=68812" alt=""></p> <blockquote><p>原创不易，转载请注明出处！谢谢！</p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">9/15/2019, 4:29:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/promise实现.html" class="prev">
        Promise实现
      </a></span> <span class="next"><a href="/blog/nodeJs流.html">
        Node.js流
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.32ac00d1.js" defer></script><script src="/assets/js/2.d723362d.js" defer></script><script src="/assets/js/20.b933b658.js" defer></script>
  </body>
</html>
